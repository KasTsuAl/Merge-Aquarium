import React, { useState, useEffect, useCallback } from 'react';
import { Fish, ShoppingBag, Coins, Trash2, ArrowUpCircle, Info, X, HelpCircle, MousePointer2, Star } from 'lucide-react';

// --- éŠæˆ²è³‡æ–™è¨­å®š ---

// é­šçš„ç¨®é¡èˆ‡å±¬æ€§ (ä¾ç…§è§£é–é †åºæ’åˆ—)
const FISH_TYPES = [
  // åˆå§‹é­šç¨® (2ç¨®)
  { id: 'clownfish', name: 'å°ä¸‘é­š', rarity: 'common', basePrice: 10, stages: ['ğŸ ', 'ğŸ¡', 'ğŸ§œâ€â™€ï¸'], color: 'bg-orange-200' },
  { id: 'blue', name: 'è—åˆ€é¯›', rarity: 'common', basePrice: 12, stages: ['ğŸŸ', 'ğŸ¬', 'ğŸ³'], color: 'bg-blue-200' },
  // æ“´å……è§£é–é­šç¨®
  { id: 'crab', name: 'ç´…èƒèŸ¹', rarity: 'common', basePrice: 15, stages: ['ğŸ¦€', 'ğŸ¦', 'ğŸ¦‚'], color: 'bg-red-200' },
  { id: 'seahorse', name: 'æµ·é¦¬', rarity: 'rare', basePrice: 20, stages: ['ğŸ¦', 'ğŸ‰', 'ğŸ²'], color: 'bg-green-200' }, // ç”¨è¦æš«ä»£æµ·é¦¬å¹¼é«”
  { id: 'gold', name: 'é‡‘é­š', rarity: 'rare', basePrice: 25, stages: ['ğŸ¡', 'ğŸ', 'ğŸ®'], color: 'bg-yellow-200' },
  { id: 'jelly', name: 'æ°´æ¯', rarity: 'rare', basePrice: 35, stages: ['ğŸ‘¾', 'ğŸ›¸', 'ğŸŒŒ'], color: 'bg-pink-200' }, // ç”¨å¤–æ˜Ÿäººåœ–ç¤ºä»£è¡¨æ°´æ¯æ„Ÿ
  { id: 'turtle', name: 'æµ·é¾œ', rarity: 'epic', basePrice: 45, stages: ['ğŸ¢', 'ğŸ¦•', 'ğŸ¦–'], color: 'bg-emerald-200' },
  { id: 'squid', name: 'é­·é­š', rarity: 'epic', basePrice: 60, stages: ['ğŸ¦‘', 'ğŸ™', 'ğŸš'], color: 'bg-indigo-200' },
  { id: 'angel', name: 'ç¥ä»™é­š', rarity: 'legendary', basePrice: 80, stages: ['ğŸ‘¼', 'ğŸ§šâ€â™€ï¸', 'ğŸ‘¸'], color: 'bg-purple-200' },
  { id: 'shark', name: 'é¯Šé­š', rarity: 'legendary', basePrice: 120, stages: ['ğŸ¦ˆ', 'ğŸŠ', 'ğŸ¦–'], color: 'bg-gray-300' },
];

const SUMMON_COST = 0;
const INITIAL_MONEY = 500;
const INITIAL_UNLOCKED_COUNT = 2; // ä¸€é–‹å§‹åªæœ‰å‰å…©ç¨®

// --- è¼”åŠ©å‡½å¼ ---

// ä¿®æ”¹ï¼šå‚³å…¥ unlockedCount ä¾†é™åˆ¶æŠ½å–çš„ç¯„åœ
const getRandomFish = (unlockedCount) => {
  // åªå¾å·²è§£é–çš„é­šç¨®ä¸­æŠ½å–
  const availableFish = FISH_TYPES.slice(0, unlockedCount);
  
  // ç°¡å–®æ¬Šé‡ï¼šè¶Šæ–°çš„é­šæ©Ÿç‡ç¨å¾®ä½ä¸€é»é»ï¼Œä½†é‚„æ˜¯è¦è®“ç©å®¶æŠ½å¾—åˆ°
  // é€™è£¡ä½¿ç”¨å®Œå…¨éš¨æ©Ÿï¼Œè®“æ–°é­šå®¹æ˜“å‡ºç¾
  const type = availableFish[Math.floor(Math.random() * availableFish.length)];

  // 10% æ©Ÿç‡ç²å¾—ç¬¬äºŒéšæ®µ (stage index 1)ï¼Œå¦å‰‡ç¬¬ä¸€éšæ®µ (index 0)
  const stage = Math.random() < 0.1 ? 1 : 0;
  
  return {
    instanceId: Math.random().toString(36).substr(2, 9),
    typeId: type.id,
    stage: stage,
  };
};

const getExpansionCost = (width, height) => {
  const area = width * height;
  return Math.floor(area * 50 * (1 + (area - 25) * 0.1));
};

// --- ä¸»çµ„ä»¶ ---

export default function AquariumGame() {
  // éŠæˆ²ç‹€æ…‹
  const [gridSize, setGridSize] = useState({ w: 5, h: 5 });
  const [cells, setCells] = useState(Array(25).fill(null)); 
  const [money, setMoney] = useState(INITIAL_MONEY);
  const [backpack, setBackpack] = useState({}); 
  const [draggedIndex, setDraggedIndex] = useState(null);
  const [showBackpack, setShowBackpack] = useState(false);
  const [showIntro, setShowIntro] = useState(true); 
  const [msg, setMsg] = useState(null); 
  const [mergingIndices, setMergingIndices] = useState([]); 

  // æ–°å¢ç‹€æ…‹ï¼šå·²è§£é–çš„é­šç¨®æ•¸é‡
  const [unlockedCount, setUnlockedCount] = useState(INITIAL_UNLOCKED_COUNT);
  // æ–°å¢ç‹€æ…‹ï¼šæ–°é­šè§£é–çš„ Modal è³‡æ–™
  const [newFishUnlocked, setNewFishUnlocked] = useState(null);

  const showMessage = (text, duration = 2000) => {
    setMsg(text);
    setTimeout(() => setMsg(null), duration);
  };

  useEffect(() => {
    setCells(prev => {
      const newTotal = gridSize.w * gridSize.h;
      if (prev.length === newTotal) return prev;
      const newCells = [...prev];
      while (newCells.length < newTotal) {
        newCells.push(null);
      }
      return newCells;
    });
  }, [gridSize]);

  // --- éŠæˆ²é‚è¼¯ ---

  const handleSummon = () => {
    if (showIntro || newFishUnlocked) return; 

    const emptyIndices = cells.map((c, i) => c === null ? i : -1).filter(i => i !== -1);
    if (emptyIndices.length === 0) {
      showMessage("é­šç¼¸å·²æ»¿ï¼è«‹åˆæˆã€å‡ºå”®æˆ–æ“´å»ºã€‚");
      return;
    }

    const randomIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
    // å‚³å…¥ unlockedCount
    const newFish = getRandomFish(unlockedCount);
    
    const newCells = [...cells];
    newCells[randomIndex] = newFish;
    
    setCells(newCells);
  };

  const handleExpand = () => {
    if (showIntro || newFishUnlocked) return;
    const cost = getExpansionCost(gridSize.w, gridSize.h);
    if (money < cost) {
      showMessage(`æ“´å»ºéœ€è¦ $${cost}`);
      return;
    }

    if (gridSize.w === 10 && gridSize.h === 10) {
      showMessage("å·²é”åˆ°æœ€å¤§å°ºå¯¸ï¼");
      return;
    }

    let newW = gridSize.w;
    let newH = gridSize.h;

    if (newW === newH) {
      newH++; 
    } else {
      newW++; 
    }

    // é‡æ–°æ’åˆ—
    const newCells = Array(newW * newH).fill(null);
    for (let y = 0; y < gridSize.h; y++) {
      for (let x = 0; x < gridSize.w; x++) {
        const oldIndex = y * gridSize.w + x;
        const newIndex = y * newW + x;
        if (cells[oldIndex]) {
          newCells[newIndex] = cells[oldIndex];
        }
      }
    }

    setGridSize({ w: newW, h: newH });
    setCells(newCells);
    setMoney(m => m - cost);
    showMessage(`é­šç¼¸æ“´å±•è‡³ ${newW} x ${newH}ï¼`);

    // --- è§£é–æ–°é­šç¨®é‚è¼¯ ---
    // æ¯æ¬¡æ“´å……ï¼Œå¦‚æœæœ‰ä¸‹ä¸€éš»é­šï¼Œå°±è§£é–å®ƒ
    if (unlockedCount < FISH_TYPES.length) {
      const nextFish = FISH_TYPES[unlockedCount];
      setUnlockedCount(prev => prev + 1);
      setNewFishUnlocked(nextFish); // è¨­å®šé€™éš»é­šç‚ºæ–°è§£é–ï¼Œè§¸ç™¼ Modal
    }
  };

  const getSellPrice = (fish) => {
    if (!fish) return 0;
    const fishType = FISH_TYPES.find(f => f.id === fish.typeId);
    return fishType.basePrice * Math.pow(3, fish.stage);
  };

  const handleSell = (index) => {
    const fish = cells[index];
    if (!fish) return;

    const sellPrice = getSellPrice(fish);

    const newCells = [...cells];
    newCells[index] = null;
    setCells(newCells);
    setMoney(m => m + sellPrice);
    showMessage(`å‡ºå”®ç²å¾— $${sellPrice}`);
  };

  const handleHarvest = (index) => {
    if (showIntro || newFishUnlocked) return;
    const fish = cells[index];
    if (!fish || fish.stage < 2) {
      showMessage("åªæœ‰å®Œå…¨é«”(ç¬¬3éšæ®µ)çš„é­šå¯ä»¥æ”¶ç©«ï¼");
      return;
    }

    setBackpack(prev => ({
      ...prev,
      [fish.typeId]: (prev[fish.typeId] || 0) + 1
    }));

    const newCells = [...cells];
    newCells[index] = null;
    setCells(newCells);
    showMessage("å·²æ”¶ç©«è‡³èƒŒåŒ…ï¼");
  };

  // --- æ‹–æ›³èˆ‡åˆæˆé‚è¼¯ ---

  const onDragStart = (e, index) => {
    if (mergingIndices.length > 0 || showIntro || newFishUnlocked) {
      e.preventDefault();
      return;
    }
    setDraggedIndex(index);
  };

  const onDragOver = (e) => {
    e.preventDefault(); 
  };

  const onDrop = (e, targetIndex) => {
    e.preventDefault();
    if (draggedIndex === null || draggedIndex === targetIndex) return;

    const sourceFish = cells[draggedIndex];
    const targetFish = cells[targetIndex];

    if (!targetFish) {
      const newCells = [...cells];
      newCells[targetIndex] = sourceFish;
      newCells[draggedIndex] = null;
      setCells(newCells);
      setDraggedIndex(null);
      return;
    }

    if (sourceFish.typeId === targetFish.typeId && sourceFish.stage === targetFish.stage) {
      if (sourceFish.stage >= 2) {
        showMessage("å·²æ˜¯æœ€é«˜ç­‰ç´šï¼Œç„¡æ³•å†åˆæˆï¼(è«‹æ”¶ç©«æˆ–å‡ºå”®)");
        setDraggedIndex(null);
        return;
      }

      const neighbors = getNeighbors(targetIndex, gridSize.w, gridSize.h);
      const validNeighbors = neighbors.filter(idx => idx !== draggedIndex);
      
      let thirdMatchIndex = -1;
      for (let idx of validNeighbors) {
        const neighborFish = cells[idx];
        if (neighborFish && 
            neighborFish.typeId === sourceFish.typeId && 
            neighborFish.stage === sourceFish.stage) {
          thirdMatchIndex = idx;
          break;
        }
      }

      if (thirdMatchIndex !== -1) {
        showMessage("âœ¨ åˆæˆæˆåŠŸï¼ âœ¨");
        setMergingIndices([draggedIndex, thirdMatchIndex]);

        setTimeout(() => {
          setCells(prevCells => {
            const newCells = [...prevCells];
            newCells[draggedIndex] = null;
            newCells[thirdMatchIndex] = null;
            
            newCells[targetIndex] = {
              ...targetFish,
              stage: targetFish.stage + 1,
              instanceId: Math.random().toString(36).substr(2, 9) 
            };
            return newCells;
          });
          setMergingIndices([]);
        }, 500);
        
      } else {
        const newCells = [...cells];
        newCells[targetIndex] = sourceFish;
        newCells[draggedIndex] = targetFish;
        setCells(newCells);
        showMessage("éœ€è¦ä¸‰éš»åŒæ¨£çš„é­šæ‰èƒ½åˆæˆä¸‹ä¸€éšï¼");
      }
    } else {
      const newCells = [...cells];
      newCells[targetIndex] = sourceFish;
      newCells[draggedIndex] = targetFish;
      setCells(newCells);
    }
    setDraggedIndex(null);
  };

  const getNeighbors = (index, w, h) => {
    const x = index % w;
    const y = Math.floor(index / w);
    const neighbors = [];
    if (x > 0) neighbors.push(index - 1); 
    if (x < w - 1) neighbors.push(index + 1); 
    if (y > 0) neighbors.push(index - w); 
    if (y < h - 1) neighbors.push(index + w); 
    return neighbors;
  };

  // --- UI çµ„ä»¶æ¸²æŸ“ ---

  const renderCell = (fish, index) => {
    const fishInfo = fish ? FISH_TYPES.find(f => f.id === fish.typeId) : null;
    const isMerging = mergingIndices.includes(index);
    const sellPrice = fish ? getSellPrice(fish) : 0;
    
    const tooltipText = fishInfo 
      ? `${fishInfo.name} (Lv.${fish.stage + 1})\nå‡ºå”®åƒ¹æ ¼: $${sellPrice}${fish.stage === 2 ? '\nâœ¨ é»æ“Šå¯æ”¶ç©«' : ''}`
      : '';

    return (
      <div
        key={index}
        className={`relative border-2 border-blue-200/50 rounded-lg flex items-center justify-center cursor-pointer select-none transition-all duration-200 overflow-hidden backdrop-blur-sm
          ${fish ? 'hover:bg-blue-50/30' : 'bg-blue-900/20'}
          ${draggedIndex === index ? 'opacity-50' : 'opacity-100'}
        `}
        style={{ aspectRatio: '1/1' }}
        onDragOver={onDragOver}
        onDrop={(e) => onDrop(e, index)}
      >
        {fish && fishInfo && (
          <div
            key={fish.instanceId}
            draggable={!isMerging}
            onDragStart={(e) => onDragStart(e, index)}
            onClick={() => fish.stage === 2 && handleHarvest(index)}
            className={`w-[90%] h-[90%] rounded-full shadow-md flex flex-col items-center justify-center text-3xl md:text-4xl ${fishInfo.color} bg-opacity-90
              ${fish.stage === 2 ? 'animate-pulse ring-2 ring-yellow-400 cursor-help' : ''}
              transition-all duration-500 ease-in-out
              ${isMerging ? 'scale-0 opacity-0 rotate-180' : 'scale-100 opacity-100 animate-[bounce_0.5s_ease-out]'}
            `}
            title={tooltipText}
          >
            <span className="filter drop-shadow-sm">{fishInfo.stages[fish.stage]}</span>
            <div className="absolute bottom-1 right-1 flex space-x-0.5">
              {Array.from({ length: fish.stage + 1 }).map((_, i) => (
                <div key={i} className="w-1.5 h-1.5 bg-yellow-500 rounded-full border border-white"></div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  const expansionCost = getExpansionCost(gridSize.w, gridSize.h);
  const isMaxValues = gridSize.w === 10 && gridSize.h === 10;
  
  const draggedFishPrice = draggedIndex !== null && cells[draggedIndex] 
    ? getSellPrice(cells[draggedIndex]) 
    : 0;

  return (
    <div 
      className="min-h-screen text-slate-800 font-sans select-none overflow-hidden flex flex-col relative bg-blue-900/30"
      style={{
        backgroundImage: 'url("https://images.unsplash.com/photo-1560275619-4662e36fa65c?q=80&w=2000&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D")',
        backgroundSize: 'cover',
        backgroundPosition: 'center',
        backgroundRepeat: 'no-repeat',
        backgroundBlendMode: 'overlay'
      }}
    >
      
      {/* æ–°æ‰‹æ•™å­¸ Modal */}
      {showIntro && (
        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white/95 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden animate-[fade-in_0.3s_ease-out]">
            <div className="bg-blue-600/90 p-4 text-white text-center">
              <h1 className="text-2xl font-bold flex items-center justify-center gap-2">
                <Fish className="animate-bounce" /> æ­¡è¿ä¾†åˆ°æ­¡æ¨‚æ°´æ—ç®±
              </h1>
            </div>
            
            <div className="p-6 space-y-6">
              <div className="space-y-4">
                <div className="flex items-start gap-4">
                  <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><MousePointer2 /></div>
                  <div>
                    <h3 className="font-bold text-lg text-slate-800">åˆæˆå‡ç´š (Merge 3)</h3>
                    <p className="text-slate-700 text-sm">æ‹–æ›³ 1 éš»é­šåˆ°å¦ä¸€éš»ç›¸åŒçš„é­šèº«ä¸Šã€‚å¦‚æœ<span className="text-red-600 font-bold">å‘¨åœé‚„æœ‰ç¬¬ 3 éš»</span>ç›¸åŒçš„é­šï¼Œå®ƒå€‘æœƒåˆé«”é€²åŒ–ï¼</p>
                  </div>
                </div>

                <div className="flex items-start gap-4">
                  <div className="bg-yellow-100 p-2 rounded-lg text-yellow-600"><ShoppingBag /></div>
                  <div>
                    <h3 className="font-bold text-lg text-slate-800">æ”¶ç©«æ¼ç²</h3>
                    <p className="text-slate-700 text-sm">ç•¶é­šé€²åŒ–åˆ° <span className="text-yellow-600 font-bold">ç¬¬ 3 éšæ®µ (å®Œå…¨é«”)</span> ä¸”ç™¼å…‰æ™‚ï¼Œé»æ“Šå®ƒå³å¯æ”¶ç©«é€²èƒŒåŒ…ã€‚</p>
                  </div>
                </div>

                <div className="flex items-start gap-4">
                  <div className="bg-red-100 p-2 rounded-lg text-red-600"><Trash2 /></div>
                  <div>
                    <h3 className="font-bold text-lg text-slate-800">å‡ºå”®æ›éŒ¢</h3>
                    <p className="text-slate-700 text-sm">é­šç¼¸æ»¿äº†å—ï¼Ÿå°‡é­šæ‹–æ›³åˆ°å³å´çš„ <span className="text-red-600 font-bold">ç´…è‰²å‡ºå”®å€</span> æ›å–é‡‘éŒ¢ï¼Œç”¨æ–¼æ“´å……é­šç¼¸ã€‚</p>
                  </div>
                </div>

                <div className="flex items-start gap-4">
                  <div className="bg-green-100 p-2 rounded-lg text-green-600"><ArrowUpCircle /></div>
                  <div>
                    <h3 className="font-bold text-lg text-slate-800">æ“´å±•èˆ‡æ–°ç‰©ç¨®</h3>
                    <p className="text-slate-700 text-sm">æ“´å……é­šç¼¸ä¸åªèƒ½å¢åŠ ç©ºé–“ï¼Œé‚„æœƒ<span className="text-green-600 font-bold">è§£é–æ–°çš„ç¨€æœ‰é­šç¨®</span>å–”ï¼</p>
                  </div>
                </div>
              </div>

              <button 
                onClick={() => setShowIntro(false)}
                className="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all"
              >
                é–‹å§‹é¤Šé­šï¼
              </button>
            </div>
          </div>
        </div>
      )}

      {/* æ–°é­šè§£é–é€šçŸ¥ Modal */}
      {newFishUnlocked && (
        <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-[fade-in_0.3s]">
          <div className="bg-white/95 rounded-3xl w-full max-w-sm shadow-[0_0_50px_rgba(255,255,255,0.5)] overflow-hidden text-center relative border-4 border-yellow-300">
            {/* å…‰èŠ’ç‰¹æ•ˆ */}
            <div className="absolute top-0 left-0 right-0 h-48 bg-gradient-to-b from-yellow-200 to-white/0 -z-10"></div>
            
            <div className="p-8 flex flex-col items-center">
              <div className="mb-4 relative">
                <Star className="absolute -top-6 -left-6 text-yellow-400 animate-spin-slow" size={40} fill="currentColor" />
                <Star className="absolute -bottom-2 -right-6 text-yellow-400 animate-pulse" size={30} fill="currentColor" />
                <div className={`w-32 h-32 rounded-full ${newFishUnlocked.color} bg-opacity-90 flex items-center justify-center text-7xl shadow-xl animate-[bounce_1s_infinite]`}>
                  {newFishUnlocked.stages[0]}
                </div>
              </div>
              
              <h2 className="text-2xl font-black text-slate-800 mb-1">æ–°ç‰©ç¨®è§£é–ï¼</h2>
              <h3 className="text-xl font-bold text-blue-600 mb-4">{newFishUnlocked.name}</h3>
              
              <p className="text-slate-600 mb-6 text-sm">
                æ­å–œæ“´å»ºæˆåŠŸï¼<br/>ç¾åœ¨å¬å–šæœ‰æ©Ÿæœƒå‡ºç¾é€™ç¨®æ–°é­šå›‰ã€‚
              </p>

              <button 
                onClick={() => setNewFishUnlocked(null)}
                className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition-transform"
              >
                å¤ªæ£’äº†ï¼
              </button>
            </div>
          </div>
        </div>
      )}

      {/* é ­éƒ¨è³‡è¨Šåˆ— */}
      <header className="bg-white/60 backdrop-blur-md p-3 shadow-md flex justify-between items-center z-10 border-b border-white/20">
        <div className="flex items-center gap-2">
          <div className="bg-yellow-100/80 p-2 rounded-full border border-yellow-300 text-yellow-800 flex items-center gap-1 font-bold min-w-[100px] justify-center shadow-sm backdrop-blur-sm">
            <Coins size={20} className="text-yellow-600" />
            <span>{money}</span>
          </div>
          <button 
            onClick={() => setShowBackpack(true)}
            className="bg-blue-500/80 hover:bg-blue-600/80 text-white p-2 rounded-full shadow-lg transition-transform active:scale-95 flex items-center gap-1 px-3 backdrop-blur-sm"
          >
            <ShoppingBag size={18} />
            <span className="hidden md:inline">èƒŒåŒ…</span>
          </button>
        </div>

        <h1 className="text-xl md:text-2xl font-bold text-white drop-shadow-lg tracking-wider flex items-center gap-2">
          ğŸŸ <span style={{textShadow: '0 2px 4px rgba(0,0,0,0.3)'}}>æ­¡æ¨‚æ°´æ—ç®±</span>
        </h1>

        <div className="flex items-center gap-2">
           <button 
             onClick={() => setShowIntro(true)} 
             className="bg-white/80 text-blue-600 p-2 rounded-full shadow-md border border-blue-200 hover:bg-white backdrop-blur-sm"
             title="éŠæˆ²èªªæ˜"
           >
             <HelpCircle size={20} />
           </button>
        </div>
      </header>

      {/* éŠæˆ²ä¸»å€åŸŸ */}
      <main className="flex-1 overflow-auto p-4 flex flex-col items-center justify-center relative">
        
        {/* å‡ºå”®å€ (Drop Zone) */}
        <div 
          className={`absolute right-4 top-4 bottom-32 w-16 md:w-24 border-2 border-dashed rounded-xl flex flex-col items-center justify-center gap-2 z-0 transition-all duration-300 backdrop-blur-sm
            ${draggedIndex !== null 
              ? 'border-red-500 bg-red-100/80 scale-105 shadow-[0_0_15px_rgba(239,68,68,0.5)]' 
              : 'border-red-300/50 bg-red-50/30 text-red-300'
            }
          `}
          onDragOver={onDragOver}
          onDrop={(e) => {
            e.preventDefault();
            if (draggedIndex !== null) handleSell(draggedIndex);
          }}
        >
          <Trash2 size={draggedIndex !== null ? 32 : 24} className={draggedIndex !== null ? 'text-red-600 animate-bounce' : 'text-red-300/80'} />
          
          <div className="text-center">
            {draggedIndex !== null ? (
              <>
                <span className="text-xs font-bold text-red-600 block">æ”¾é–‹å‡ºå”®</span>
                <span className="text-sm font-black text-red-700 block bg-white/50 rounded px-1 mt-1">
                  ${draggedFishPrice}
                </span>
              </>
            ) : (
              <span className="text-xs font-bold writing-mode-vertical text-center text-red-300/80">æ‹–æ›³<br/>å‡ºå”®</span>
            )}
          </div>
        </div>

        {/* ç¶²æ ¼ */}
        <div 
          className="bg-blue-900/20 p-2 md:p-4 rounded-xl shadow-2xl backdrop-blur-md border-4 border-blue-400/30 transition-all duration-500 ease-in-out"
          style={{
            display: 'grid',
            gridTemplateColumns: `repeat(${gridSize.w}, minmax(0, 1fr))`,
            width: '100%',
            maxWidth: '600px', 
            gap: '0.25rem',
            boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.1)'
          }}
        >
          {cells.map((fish, index) => renderCell(fish, index))}
        </div>

        {/* æ“´å……æŒ‰éˆ• */}
        {!isMaxValues && (
          <button 
            onClick={handleExpand}
            className="mt-4 bg-green-500/90 hover:bg-green-600/90 text-white text-sm py-1 px-4 rounded-full shadow-lg flex items-center gap-1 transition-all opacity-90 hover:opacity-100 backdrop-blur-sm border border-green-400/50"
          >
            <ArrowUpCircle size={16} />
            æ“´å…… ({gridSize.w}x{gridSize.h} âœ {gridSize.w === gridSize.h ? gridSize.w : gridSize.w+1}x{gridSize.w === gridSize.h ? gridSize.h+1 : gridSize.h}) - ${expansionCost}
          </button>
        )}

        {/* æç¤ºè¨Šæ¯ */}
        {msg && (
          <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/70 text-white px-4 py-2 rounded-lg animate-fade-in z-50 pointer-events-none whitespace-nowrap backdrop-blur-sm">
            {msg}
          </div>
        )}
      </main>

      {/* åº•éƒ¨æ§åˆ¶åˆ— */}
      <footer className="bg-white/60 backdrop-blur-md p-4 pb-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex justify-center items-center gap-6 z-20 border-t border-white/20">
        <div className="flex flex-col items-center">
          <button 
            onClick={handleSummon}
            className="relative group bg-gradient-to-r from-blue-500 to-indigo-600 text-white w-20 h-20 rounded-full shadow-xl flex items-center justify-center transform transition-all active:scale-90 hover:scale-105"
          >
            <div className="absolute inset-0 rounded-full bg-white opacity-0 group-hover:opacity-20 transition-opacity"></div>
            <span className="text-4xl filter drop-shadow">ğŸ£</span>
            <div className="absolute -bottom-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full border border-yellow-600 shadow-sm">
              å…è²»
            </div>
          </button>
          <span className="text-xs font-bold text-blue-800 mt-2 drop-shadow-sm">éš¨æ©Ÿå¬å–š</span>
        </div>
      </footer>

      {/* èƒŒåŒ… Modal */}
      {showBackpack && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white/95 rounded-2xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <div className="p-4 bg-blue-600/90 text-white flex justify-between items-center">
              <h2 className="text-xl font-bold flex items-center gap-2"><ShoppingBag /> æ¼ç²èƒŒåŒ…</h2>
              <button onClick={() => setShowBackpack(false)} className="hover:bg-blue-700/50 p-1 rounded transition-colors"><X /></button>
            </div>
            
            <div className="p-4 overflow-y-auto flex-1 bg-blue-50/50">
              {Object.keys(backpack).length === 0 ? (
                <div className="text-center text-gray-400 py-10">
                  <p className="text-5xl mb-2 opacity-50">ğŸ•¸ï¸</p>
                  <p>èƒŒåŒ…æ˜¯ç©ºçš„ï¼Œå¿«å»åˆæˆæ”¶ç©«å§ï¼</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {FISH_TYPES.map(type => {
                    const count = backpack[type.id] || 0;
                    if (count === 0) return null;
                    return (
                      <div key={type.id} className="flex items-center justify-between bg-white/80 p-3 rounded-lg border border-blue-100 shadow-sm">
                        <div className="flex items-center gap-3">
                          <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${type.color} bg-opacity-90 shadow-inner`}>
                            {type.stages[2]}
                          </div>
                          <div>
                            <div className="font-bold text-slate-700">{type.name}</div>
                            <div className="text-xs text-slate-500 capitalize">{type.rarity}</div>
                          </div>
                        </div>
                        <div className="text-xl font-bold text-blue-600">x {count}</div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            
            <div className="p-4 bg-gray-50/80 text-xs text-gray-500 text-center border-t border-gray-200">
              æ”¶é›†è¶Šå¤šç¨€æœ‰é­šç¨®ï¼Œè­‰æ˜ä½ çš„é¤Šæ®–å¯¦åŠ›ï¼
            </div>
          </div>
        </div>
      )}

    </div>
  );
}
